---
output: 
  html_document: 
    keep_md: yes
---
# Sorting photo directories with R and exiftool

We were fans of Google's Picasa photo organization software, but when it was discontinued, I decided that I would like to transfer all my digital photos onto an external drive and then into Adobe Lightroom. To do so, however, my "research" told me that it would be best to group them into catalogs based on year, mainly because I have on the order of 10<sup>5</sup> photos.

Right now I have my pictures organized into about 300-400 directories by event. I decided I wanted to organize all of my folders as directories within year directories. So all the 2016 folders would need to be sorted into a 2016 directory, all the 2015 folders would go into a 2015 directory, etc.

```
-2016
--Mom's birthday
--Valentine's Day
--Big Island Trip
-2015
--Schofield Days
--Bellows Camp
--etc...
```

The problem was most of the folders are titled things like "Kindergarten Graduation" or "Anacapa". Some of them had the date in them (Maui 2012), or I could remember the date (Our Wedding). But for about 350 of them, there was no date in the folder title, and to figure out when these pictures were from, I would have to manually look at each directory, check the date from the EXIF data, and then sort those into the proper folder. Even if it took 1 minute per folder, that would take me 6 hours. So I decided I could spend 6 hours doing this manually or 6 hours learning some way to automate it. 

A quick search online brought me to [`exiftool`](http://www.sno.phy.queensu.ca/~phil/exiftool/). This is a command line program that allows for reading and writing photo metadata. It has lots of awesome quotes on the webpage, and the one that sealed the deal was this one:

> "... it is total f***ing gibberish to me." - [Reddit Linux Questions](https://www.reddit.com/r/linuxquestions/comments/2yiked/i_want_to_batch_extract_the_exif_datetime_from_10/)

After some fooling around, I discovered that I could extract the date at the command line and send it to a .csv (in Mac OS X). Adding other EXIF attributes allows you to extract more data, but since I didn't really want anything else, I just pulled the filename and the DateTimeOriginal attributes.

```
> exiftool -DateTimeOriginal -S -s -csv ./*/ > all_photos_dates.csv
```

Sweet! Now that's something I can work with!

First, I needed to read in the data then let's take a look:

```{r}
library(dplyr)
library(stringr)
library(tidyr)
photos <- read.csv(file = "~/Dropbox/Mike/photo_analysis/all_photo_dates.csv")
photos <- tbl_df(photos)
photos
```

We can see that the `exiftool` command read in the file names in the format "./directoryname/filename". I need to split out that directory name and the component files. We can do it using the `separate` function from `tidyr`.

```{r}
photos <- photos %>% separate(SourceFile, c("dot", "dname", "fname"), sep = "/", remove = TRUE)
photos <- photos[,2:4]
photos
```

Ok, next thing we need to do is to take care of that date column and put it into a form that R can work with. I used POSIXct because POSIXlt caused problems when trying to add it to the data frame. This is because POSIXlt is a list, and POSIXct represents the number of seconds since the beginning of 1970.

```{r}
photos$DateTimeOriginal <- as.POSIXct(strptime(photos$DateTimeOriginal, format = "%Y:%m:%d %H:%M:%S"))
```

One of the problems with POSIXct is that it's not as easy to get the year out compared to POSIXlt. No problem, we can just temporarily convert to POSIXlt and add 1900 (the start date of POSIXlt years).

```{r}
photos <- photos %>% mutate(year = as.POSIXlt(DateTimeOriginal)$year + 1900)
photos
```

Now we want to get a summary of the years of the photos in each folder. I used the mode function from [here](http://stackoverflow.com/questions/2547402/is-there-a-built-in-function-for-finding-the-mode) to find out what was the most common year of the photos in each folder.

```{r}
Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

folder_years <- photos %>% group_by(dname) %>% summarize(year = Mode(year))
folder_years
```

Finally it'd be great if we could get a list of all the folders corresponding to each year. To do this, I created an empty list then populated it based on the most common year of the photos in each folder.

```{r}
folder_output <- list()

for(i in sort(unique(folder_years$year))) {
  x <- folder_years %>% filter(year == i)
  folder_output[as.character(i)][1] <- x[,1]
}
```

It worked great, and here's a sampling:

```{r}
folder_output[["2010"]]
```

I would like to write these out to files with quotes around the names, and the filename being the year. For example 2010.txt with "Dayton's 5th birthday" "Gus Ryan Phillip Visit" etc.

For each 1st level list in `folder_output`, get the contents, put quotes around them, and then write it out.

```{r}
x <- folder_output[["2003"]]
x <- folder_output[[3]]
str(x)
x

format_dir_list <- function(x) {
  z <- NA
  for (i in 1:length(x)) {
    z[i] <- paste0("\'", x[i], "\'")
  }
  return(cat(z))
}

format_dir_list(folder_output[[2]])


for (i in 1:16) {
  cat("\n")
  print(names(folder_output)[i])
  cat("\n")
  format_dir_list(folder_output[[i]])
  cat("\n")
}
```